<!DOCTYPE html>
<html lang="{{ html_lang }}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ title }}</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f5f5;
  --card: #bbc7c9;
  --card-text: #303030;
  --border: #26c6da;
  --link: #3c506b;
  --entity-bg: #fff;
  --entity-border: #96b9bd;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: #333; line-height: 1.6; max-width: 820px; margin: 0 auto; padding: 2rem 1rem; }
h1 { font-size: 1.8rem; margin-bottom: 1.5rem; }
h2 { font-size: 1.3rem; margin: 2rem 0 1rem; border-bottom: 2px solid #ccc; padding-bottom: .3rem; }
h3 { font-size: 1.1rem; margin-bottom: .3rem; }
.card { background: var(--card); color: var(--card-text); border-radius: 8px; padding: 1rem 1.2rem; margin-bottom: .8rem; }
.card .tags { font-weight: 900; margin-bottom: .4rem; }
.card ul { margin: .4rem 0 0 1.2rem; }
.card li { margin-bottom: .2rem; }
.card a { color: var(--link); text-decoration: none; }
.card a:hover { color:white; background: var(--link); padding: 0.2rem; border-radius: 2px; }
.toggle { text-align: right; font-size: .85rem; color: #555; cursor: pointer; user-select: none; margin-bottom: .2rem; }
.toggle:hover { color: var(--link); }
.chunk-original { display: none; background: #e0e0e0; border-radius: 8px; padding: 1rem 1.2rem; margin-bottom: .8rem; white-space: pre-wrap; font-size: .9rem; }
a.entity-link { color: var(--link); text-decoration: none; border-bottom: 1px dashed var(--link); }
a.entity-link:hover { color: white; border-bottom-style: solid; }
.entity-card { background: var(--entity-bg); border: 1px solid var(--entity-border); border-radius: 8px; padding: 1rem 1.2rem; margin-bottom: .8rem; }
.entity-card h3 { color: #00796b; }
.entity-card .desc { color: #555; margin: .3rem 0 .6rem; }
.entity-card ul { margin: 0 0 .6rem 1.2rem; }
.entity-card li { margin-bottom: .2rem; }
.chunk-links { font-size: .85rem; color: #777; }
.chunk-links a { color: var(--link); text-decoration: none; }
.chunk-links a:hover { text-decoration: underline; }
.footer { font-size: .8rem; color: #696969; margin-top: 2rem; border-top: 1px solid #ddd; padding-top: 1rem; text-align: center; text-decoration: none; }
.footer a { color: var(--link); text-decoration: none; }
.footer a:hover { text-decoration: underline; }
.detail { font-size: .9rem; color: #555; margin-top: 1rem; }
.disclaimer { font-size: .6rem; color: #696969; margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem; text-align: left; border-bottom: 1px solid #ddd; padding-bottom: 1rem; }
#graph { height: 420px; background: #fff; border: 1px solid #cfd8dc; border-radius: 8px; margin-bottom: 1rem; }
#node-info { background: #fff; border: 1px solid #cfd8dc; border-radius: 8px; padding: .8rem 1rem; margin-bottom: 1rem; display: none; }
#node-info a { color: var(--link); text-decoration: none; }
#node-info a:hover { color:white; background: var(--link); padding: 0.2rem; border-radius: 2px; }
#node-info h4 { margin-bottom: .4rem; }
.node-info-name { font-weight: 900; color: var(--link); }
</style>
</head>
<body>

<h1>{{ title }}</h1>

{# Summary card #}
<div class="card">
{% if summary %}
<p>{{ summary }}</p>
{% endif %}
<div class="detail">{{ extracted_info }}</div>
{% if url %}
<div class="detail">{{ labels.source }}: <a href="{{ url }}" target="_blank" rel="noopener noreferrer">{{ url }}</a></div>
{% endif %}
</div>

{# Navigation #}
<div class="card">
‣<a href="#chunks">{{ labels.nav_chunks }}</a>
‣<a href="#topics">{{ labels.nav_topics }}</a>
‣<a href="#entities">{{ labels.nav_entities }}</a>
</div>

{# Graph section #}
<h2 id="graph-title">{{ labels.network_title }}</h2>
<div id="graph"></div>
<div id="node-info"></div>

{# Topics (communities) section #}
<h2 id="topics">{{ labels.topics_title }}</h2>
{% for community in communities %}
<div class="card">
<div class="tags">{{ community.topics | join(', ') }}</div>
<ul>
{% if community.description %}
<li>{{ community.description }}</li>
{% endif %}
{% if community.member_links %}
<li>{{ community.member_links | safe }}</li>
{% endif %}
</ul>
</div>
{% endfor %}

{# Content (chunks) section #}
<h2 id="chunks">{{ labels.content_title }}</h2>
{% for chunk in chunks_display %}
<div class="toggle" onclick="toggleChunk('{{ chunk.id }}')">{{ labels.show_original }}</div>
<div class="card" id="{{ chunk.id }}-rephrase">{{ chunk.linkified | safe }}</div>
<div class="chunk-original" id="{{ chunk.id }}-original">{{ chunk.original }}</div>
{% endfor %}

{# Entities section #}
<h2 id="entities">{{ labels.entities_title }}</h2>
{% for entity in entities_display %}
<div class="entity-card" id="{{ entity.anchor }}">
<h3>{{ entity.name }}</h3>
{% if entity.description %}
<div class="desc">{{ entity.description }}</div>
{% endif %}
{% if entity.relations %}
<ul>
{% for rel in entity.relations %}
<li>{{ rel | safe }}</li>
{% endfor %}
</ul>
{% endif %}
{% if entity.chunk_links %}
<div class="chunk-links">{{ labels.appears_in }}: {{ entity.chunk_links | safe }}</div>
{% endif %}
</div>
{% endfor %}

{# Footer #}
<div class="footer">
<div>Generated by <a title="Knwl AI" target="_blank" href="https://knwl.ai">Knwl</a>, &copy; 2026 <a href="https://graphsandnetworks.com" title="Orbifold Consulting">Orbifold Consulting</a>.</div>
<div class="disclaimer">{{ disclaimer }}</div>
</div>

{# Scripts #}
<script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/layout-base@2.0.1/layout-base.js"></script>
<script src="https://unpkg.com/cose-base@2.2.0/cose-base.js"></script>
<script src="https://unpkg.com/cytoscape-fcose@2.2.0/cytoscape-fcose.js"></script>
<script>
if (window.cytoscape && window.cytoscapeFcose) {
    cytoscape.use(cytoscapeFcose);
}

// Localized labels
const labels = {{ js_labels | tojson }};

const graphElements = {
    nodes: {{ node_elements | tojson }},
    edges: {{ edge_elements | tojson }}
};

const communityDesc = {{ community_desc | tojson }};

const colors = [
    '#6baed6','#9ecae1','#c6dbef','#74c476','#a1d99b',
    '#c7e9c0','#fd8d3c','#fdae6b','#fdd0a2','#9e9ac8'
];

function colorForCommunity(cid) {
    if (cid === null || cid === undefined || cid === '') return '#bdbdbd';
    return colors[Math.abs(parseInt(cid, 10)) % colors.length];
}

const cy = cytoscape({
    container: document.getElementById('graph'),
    elements: graphElements,
    layout: { name: 'fcose', animate: true, randomize: true, nodeRepulsion: 4500 },
    style: [
        { selector: 'node', style: {
                'label': 'data(label)',
                'text-valign': 'center',
                'text-halign': 'center',
                'font-size': 8,
                'background-color': (ele) => colorForCommunity(ele.data('community_id')),
                'width': 18,
                'height': 18,
                'color': '#263238'
        } },
        { selector: 'edge', style: {
                'width': 1,
                'line-color': '#90a4ae',
                'target-arrow-color': '#90a4ae',
                'target-arrow-shape': 'triangle',
                'curve-style': 'bezier'
        } }
    ]
});

const info = document.getElementById('node-info');
cy.on('tap', 'node', (evt) => {
    const d = evt.target.data();
    const chunks = (d.chunk_ids || [])
        .map((cid) => `<a href="#chunk-${cid}-rephrase">${labels.chunk} ${cid}</a>`)
        .join(', ');
    const cdesc = communityDesc[String(d.community_id)] || '';
    info.style.display = 'block';
    info.innerHTML = `
        <div class='node-info-name'>${d.label.toUpperCase() || ''}</div>
        <div><strong>${labels.type}:</strong> ${d.type || ''}</div>
        <div><strong>${labels.description}:</strong> ${d.description || ''}</div>
        <div><strong>${labels.community}:</strong> ${cdesc}</div>
        <div><strong>${labels.chunks}:</strong> ${chunks}</div>
    `;
});
cy.on('tap', (evt) => {
    if (evt.target === cy) {
        info.style.display = 'none';
    }
});

function toggleChunk(id) {
    const reph = document.getElementById(id + '-rephrase');
    const orig = document.getElementById(id + '-original');
    const toggle = reph.previousElementSibling;
    if (orig.style.display === 'block') {
        orig.style.display = 'none';
        reph.style.display = 'block';
        toggle.textContent = labels.showOriginal;
    } else {
        orig.style.display = 'block';
        reph.style.display = 'none';
        toggle.textContent = labels.showRephrased;
    }
}
</script>
</body>
</html>
